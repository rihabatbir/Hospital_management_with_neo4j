<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Visualisation des Parcours</title>
  <script src="https://cdn.jsdelivr.net/npm/neovis.js@1.5.0/dist/neovis.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 min-h-screen">
  <h1 class="text-3xl font-bold text-center mb-6 text-indigo-700">üß† Parcours de Soins du Patient</h1>

  <div class="max-w-xl mx-auto mb-6">
    <label for="patientId" class="block text-sm mb-2 text-gray-700">S√©lectionner un patient :</label>
    <div class="flex gap-2">
      <select id="patientId" class="flex-grow px-4 py-2 border rounded">
        <option value="">-- Chargement... --</option>
      </select>
      <button onclick="drawGraph()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">üîç Afficher</button>
    </div>
  </div>

  <div id="viz" style="width: 100%; height: 900px;"></div>

  <script>
    let viz;

    async function chargerPatients() {
      const select = document.getElementById("patientId");
      try {
        const res = await fetch("http://localhost:3001/patients/ids");
        const ids = await res.json();
        select.innerHTML = '<option value="">-- Choisir un patient --</option>';
        ids.forEach(id => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = id;
          select.appendChild(option);
        });
      } catch (err) {
        console.error("Erreur chargement patients:", err);
        select.innerHTML = '<option value="">‚ùå Erreur chargement</option>';
      }
    }

    function drawGraph() {
      const pid = document.getElementById("patientId").value.trim();
      if (!pid) return alert("Veuillez s√©lectionner un patient");

      const config = {
        container_id: "viz",
        server_url: "bolt://localhost:7687",
        server_user: "neo4j",
        server_password: "neo4jdb2025",

        labels: {
          Patient: { caption: "patient_id", color: "#2ca02c" },
          Medecin: { caption: "nom", color: "#ff7f0e" },
          RendezVous: { caption: "rdv_id", color: "#1f77b4" },
          Traitement: { caption: "nom", color: "#d62728" },
          Diagnostic: { caption: "pathologie", color: "#9467bd" },
          Service: { caption: "nom", color: "#bcbd22" },
          User: { caption: "email", color: "#17becf" }
        },

        relationships: {
          A_RECU: { caption: true },
          A_POUR_MEDECIN: { caption: true },
          A_POUR_PATIENT: { caption: true },
          A_EU_RENDEZVOUS: { caption: true },
          A_RECU_DIAGNOSTIC: { caption: true },
          A_PRESCRIT: { caption: true },
          REPRESENTE: { caption: true },
          EST: { caption: true },
          EXERCE_DANS: { caption: true },
          TRAVAILLE_DANS: { caption: true },
          LIE_A: { caption: true },
          PRESCRIT: { caption: true },
          POSE: { caption: true },
          TRAITE_PAR: { caption: true }
        },

        initial_cypher: `
          MATCH path = (p:Patient {patient_id: "${pid}"})-[:A_EU_RENDEZVOUS|A_RECU_DIAGNOSTIC|A_RECU|A_PRESCRIT|A_POUR_MEDECIN|A_POUR_PATIENT|REPRESENTE|POSE|PRESCRIT|TRAITE_PAR|EXERCE_DANS|TRAVAILLE_DANS*1..3]-(x)
          RETURN path
        `,

        visConfig: {
          nodes: {
            shape: "dot",
            size: 20,
            font: {
              size: 18,
              face: "Arial",
              color: "#222"
            }
          },
          edges: {
            arrows: { to: { enabled: true, scaleFactor: 1 } },
            font: {
              size: 13,
              color: "#333",
              align: "middle"
            },
            smooth: {
              enabled: true,
              type: "cubicBezier",
              roundness: 0.4
            }
          },
          layout: {
            hierarchical: {
              enabled: true,
              direction: "UD", // Haut ‚Üí Bas
              sortMethod: "directed",
              levelSeparation: 200,
              nodeSpacing: 150,
              treeSpacing: 250
            }
          },
          physics: {
            enabled: false
          }
        }
      };

      if (viz) viz.clearNetwork();
      viz = new NeoVis.default(config);
      viz.render();
    }

    window.addEventListener("DOMContentLoaded", chargerPatients);
  </script>
</body>
</html>
